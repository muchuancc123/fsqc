const Roles={SUPER:"super_admin",ADMIN:"admin",OP:"operator"};
const Ranges={DAILY:"daily",WEEKLY:"weekly",MONTHLY:"monthly",ALL:"all"};
const state={currentUser:null,users:[],channels:[],customers:[],duplicates:[],key:null,range:Ranges.ALL,page:'home',usersPage:1,usersPageSize:20,usersSearch:''};
const API_BASE=location.origin;
function rid(){try{if(typeof crypto!=="undefined"&&crypto.randomUUID){return crypto.randomUUID()}}catch(e){}return 'id_'+Math.random().toString(36).slice(2)+Date.now()}
async function apiReq(path,method,body){const res=await fetch(API_BASE+path,{method,headers:{'Content-Type':'application/json'},credentials:'include',body:body?JSON.stringify(body):undefined});if(!res.ok){let j=null;let msg='error';try{j=await res.json();msg=j.error||msg}catch(e){}const err=new Error(msg);err.code=res.status;err.data=j;throw err}return res.json()}
function apiGet(path){return apiReq(path,'GET')}
function apiPost(path,body){return apiReq(path,'POST',body)}
function apiPatch(path,body){return apiReq(path,'PATCH',body)}
function apiDelete(path){return apiReq(path,'DELETE')}
async function batchImportCustomers(phones, channelId, operatorId){return apiPost('/api/customers/batch', { phones, channel_id: channelId, operator_id: operatorId })}
function t(s){return s.trim()}
function n(input){let s=t(input);if(/[A-Za-z]/.test(s))throw new Error("invalid");if(/[\u4e00-\u9fff]/.test(s))throw new Error("invalid");s=s.replace(/[\s+()\-－—]/g,"");let r="";for(let i=0;i<s.length;i++){const c=s[i];if(c>='0'&&c<='9')r+=c}if(r.length<4||r.length>11)throw new Error("invalid");return r}
async function sha256Hex(text){const buf=new TextEncoder().encode(text);const d=await crypto.subtle.digest("SHA-256",buf);const a=new Uint8Array(d);let h="";for(const b of a)h+=b.toString(16).padStart(2,"0");return h}
async function genKey(){try{if(typeof crypto!=="undefined"&&crypto.subtle){state.key=await crypto.subtle.generateKey({name:"AES-GCM",length:256},true,["encrypt","decrypt"])}else{state.key=null}}catch(e){state.key=null}}
async function encrypt(text){if(!state.key){return btoa(text)}const iv=crypto.getRandomValues(new Uint8Array(12));const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},state.key,new TextEncoder().encode(text));const combined=new Uint8Array(iv.length+ct.byteLength);combined.set(iv,0);combined.set(new Uint8Array(ct),iv.length);return btoa(String.fromCharCode(...combined))}
function b64ToBytes(b64){const bin=atob(b64);const bytes=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);return bytes}
async function decrypt(b64){if(!state.key){return atob(b64)}const data=b64ToBytes(b64);const iv=data.slice(0,12);const ct=data.slice(12);const pt=await crypto.subtle.decrypt({name:"AES-GCM",iv},state.key,ct);return new TextDecoder().decode(pt)}
function showToast(msg){const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>{try{document.body.removeChild(t)}catch(e){}},1600)}
function openAlert(msg){const overlay=c('div','modal');const panel=c('div','panel');const title=c('div','title');title.textContent='提示';const body=c('div');body.textContent=msg;const ok=c('button','btn btn-primary');ok.textContent='确定';ok.onclick=()=>document.body.removeChild(overlay);panel.append(title,body,ok);overlay.append(panel);document.body.append(overlay)}
function highlightChannelByName(name){const tables=document.querySelectorAll('table');let row=null;tables.forEach(tb=>{const tbody=tb.querySelector('tbody');if(!tbody)return;Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{const td=tr.querySelector('td');if(td&&td.textContent===name){row=tr}})});if(row){row.classList.add('hl');setTimeout(()=>{try{row.classList.remove('hl')}catch(e){}},1500);try{row.scrollIntoView({behavior:'smooth',block:'center'})}catch(e){}}}
async function fetchChannels(){try{state.channels=await apiGet('/api/channels')}catch(e){state.channels=[]}}
function seed(){}
function channelExists(name){return state.channels.some(c=>c.name.toLowerCase()===name.toLowerCase())}
async function createChannel({name,creator_id,owner_admin_id}){if(!name)throw new Error("invalid");const created=await apiPost('/api/channels',{name,creator_id,owner_admin_id});if(created&&created.id){state.channels.push(created);saveChannels();return created}throw new Error('error')}
function listAdmins(){return state.users.filter(u=>u.role===Roles.ADMIN)}
function listOperators(adminId){return state.users.filter(u=>u.role===Roles.OP&&u.parent_id===adminId)}
function usernameExists(name){return state.users.some(u=>u.username===name)}
function randSalt(){return Math.random().toString(36).slice(2,6)}
async function updatePasswordByAdmin(requester,target_user_id,new_password){const target=state.users.find(u=>u.id===target_user_id&&u.is_active);if(!target)throw new Error("notfound");if(!new_password||new_password.length<6)throw new Error("weak");if(requester.role===Roles.SUPER||(requester.role===Roles.ADMIN&&target.role===Roles.OP&&target.parent_id===requester.id)){await apiPatch('/api/users/'+target_user_id,{new_password:new_password});await fetchUsers();return true}throw new Error("forbidden")}
async function updateOwnPassword(user,new_password){if(!new_password||new_password.length<6)throw new Error("weak");await apiPatch('/api/users/'+user.id,{new_password:new_password});await fetchUsers();return true}
async function createAdmin({username,display_name,password}){if(!username||!display_name||!password)throw new Error("invalid");const created=await apiPost('/api/admins',{username,display_name,password});if(created&&created.id){state.users.push(created);saveUsers();return created}throw new Error('error')}
async function createOperator({username,display_name,password,owner_admin_id}){if(!username||!display_name||!password||!owner_admin_id)throw new Error("invalid");const created=await apiPost('/api/operators',{username,display_name,password,owner_admin_id});if(created&&created.id){state.users.push(created);saveUsers();return created}throw new Error('error')}
function login(u,p){const user=state.users.find(x=>x.username===u);if(!user)return 'wrong';if(!user.is_active)return 'disabled';if(user.role===Roles.OP){const adm=state.users.find(a=>a.id===user.parent_id);if(!adm||!adm.is_active)return 'disabled'}const expect=user.password_hash;if(p+user.salt===expect){state.currentUser=user;return 'ok'}return 'wrong'}
function logout(){state.currentUser=null}
function allowedChannels(user){if(user.role===Roles.SUPER){return state.channels.filter(c=>c.is_active)}if(user.role===Roles.ADMIN){return state.channels.filter(c=>c.is_active&&c.owner_admin_id===user.id)}if(user.role===Roles.OP){return state.channels.filter(c=>c.is_active&&c.owner_admin_id===user.parent_id)}return []}
async function createCustomer(phone_raw,channel_id,operator_id){const op=state.users.find(u=>u.id===operator_id&&u.role===Roles.OP);if(!op||!op.parent_id)throw new Error("auth");try{const res=await apiPost('/api/customers',{phone_raw,channel_id,operator_id});if(res&&res.status){return res}throw new Error('error')}catch(e){const normalized=n(phone_raw);const phone_hash=await sha256Hex(normalized);const phone_encrypted=await encrypt(normalized);const admin_id=op.parent_id;const existing=state.customers.find(c=>c.phone_hash===phone_hash&&c.owner_admin_id===admin_id);if(existing){const dup={id:rid(),customer_id:existing.id,first_owner_id:existing.owner_operator_id,duplicate_operator_id:op.id,duplicate_channel_id:channel_id,duplicate_at:Date.now()};state.duplicates.push(dup);const owner=state.users.find(u=>u.id===existing.owner_operator_id);return{status:"duplicate",existing_owner:owner,existing_created_at:existing.created_at}}else{const c={id:rid(),phone_raw,phone_normalized:normalized,phone_hash,phone_encrypted,channel_id,owner_operator_id:op.id,owner_admin_id:admin_id,created_at:Date.now(),extra_info:{}};state.customers.push(c);return{status:"success"}}}}
function customersFor(user){
  if(user.role===Roles.SUPER) return state.customers;
  if(user.role===Roles.ADMIN){
    const own=state.customers.filter(c=>c.owner_admin_id===user.id);
    const ops=state.users.filter(u=>u.role===Roles.OP&&u.parent_id===user.id).map(u=>u.id);
    const setOps=new Set(ops);
    const extraIds=new Set(state.duplicates.filter(d=>setOps.has(d.duplicate_operator_id)).map(d=>d.customer_id));
    const extras=state.customers.filter(c=>extraIds.has(c.id));
    const map=new Map();
    [...own,...extras].forEach(c=>map.set(c.id,c));
    return Array.from(map.values());
  }
  if(user.role===Roles.OP) return state.customers.filter(c=>c.owner_operator_id===user.id);
  return [];
}
async function fetchDuplicates(){try{const dups=await apiGet('/api/duplicates');state.duplicates=Array.isArray(dups)?dups:[]}catch(e){state.duplicates=[]}}
function duplicatesFor(customer_id){return state.duplicates.filter(d=>d.customer_id===customer_id)}
function duplicateCountFor(owner_operator_id){return state.duplicates.filter(d=>d.first_owner_id===owner_operator_id).length}
function inSameDay(d,now){const a=new Date(d),b=new Date(now);return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}
function inSameWeek(d,now){const a=new Date(d),b=new Date(now);const f=x=>{const s=new Date(x);s.setHours(0,0,0,0);s.setDate(s.getDate()-((s.getDay()+6)%7));return s};const wa=f(a),wb=f(b);return wa.getFullYear()===wb.getFullYear()&&wa.getMonth()===wb.getMonth()&&wa.getDate()===wb.getDate()}
function inSameMonth(d,now){const a=new Date(d),b=new Date(now);return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()}
function stats(user,range){const now=Date.now();const dateFilter=d=>range===Ranges.ALL?true:range===Ranges.DAILY?inSameDay(d,now):range===Ranges.WEEKLY?inSameWeek(d,now):inSameMonth(d,now);const scopedCustomers=customersFor(user).filter(c=>dateFilter(c.created_at));let scopedDuplicates=[];if(user.role===Roles.SUPER){scopedDuplicates=state.duplicates.filter(d=>dateFilter(d.duplicate_at))}else if(user.role===Roles.ADMIN){const ops=state.users.filter(u=>u.role===Roles.OP&&u.parent_id===user.id).map(u=>u.id);const set=new Set(ops);scopedDuplicates=state.duplicates.filter(d=>dateFilter(d.duplicate_at)&&set.has(d.duplicate_operator_id))}else{scopedDuplicates=state.duplicates.filter(d=>dateFilter(d.duplicate_at)&&d.duplicate_operator_id===user.id)}const total_input=scopedCustomers.length+scopedDuplicates.length;const duplicate_cnt=scopedDuplicates.length;const set=new Set(scopedCustomers.map(c=>c.phone_hash));const valid_cnt=set.size;return{total_input,duplicate_cnt,valid_cnt}}
function q(sel){return document.querySelector(sel)}
function c(tag,cls){const el=document.createElement(tag);if(cls)el.className=cls;return el}
function openBatchImportModal(user,defaultOperatorId,defaultChannelId){const overlay=c('div','modal');const panel=c('div','panel');const title=c('div','title');title.textContent='批量导入手机号';const fields=c('div');let opSel=null;let chSel=null;let admSel=null;if(user.role===Roles.SUPER||user.role===Roles.ADMIN){if(!defaultOperatorId){if(user.role===Roles.SUPER){admSel=c('select');listAdmins().forEach(a=>{const o=c('option');o.value=a.id;o.textContent=a.display_name;admSel.append(o)});opSel=c('select');const fillOps=()=>{opSel.innerHTML='';listOperators(admSel.value).forEach(o=>{const opt=c('option');opt.value=o.id;opt.textContent=o.display_name;opSel.append(opt)})};fillOps();admSel.onchange=fillOps;const lAdm=c('div','label');lAdm.textContent='管理员';fields.append(lAdm,admSel);const lOp=c('div','label');lOp.textContent='运营';fields.append(lOp,opSel)}else{opSel=c('select');listOperators(user.id).forEach(o=>{const opt=c('option');opt.value=o.id;opt.textContent=o.display_name;opSel.append(opt)});const lOp=c('div','label');lOp.textContent='运营';fields.append(lOp,opSel)}}chSel=c('select');const chs=user.role===Roles.SUPER?state.channels.filter(x=>x.is_active):allowedChannels(user);chs.forEach(ch=>{const o=c('option');o.value=ch.id;o.textContent=ch.name;chSel.append(o)});const lCh=c('div','label');lCh.textContent='渠道';fields.append(lCh,chSel)}else{chSel=c('select');allowedChannels(user).forEach(ch=>{const o=c('option');o.value=ch.id;o.textContent=ch.name;chSel.append(o)});const lCh=c('div','label');lCh.textContent='渠道';fields.append(lCh,chSel)}const ta=document.createElement('textarea');ta.rows=10;ta.placeholder='请粘贴手机号，一行一个...';const tip=c('div','sub');const btn=c('button','btn btn-primary');btn.textContent='开始导入';const results=c('div');results.style.display='none';const resolveIds=()=>{const operatorId=defaultOperatorId||(opSel?opSel.value:(user.role===Roles.OP?user.id:null));const channelId=defaultChannelId||(chSel?chSel.value:null);return{operatorId,channelId}};btn.onclick=async()=>{const arr=(ta.value||'').split('\n').map(t=>t.trim()).filter(t=>t);if(arr.length===0){openAlert('请输入手机号');return}const {operatorId,channelId}=resolveIds();if(!operatorId||!channelId){openAlert('请选择运营和渠道');return}btn.textContent='导入中...';btn.disabled=true;try{const res=await batchImportCustomers(arr,channelId,operatorId);ta.value='';results.style.display='block';const msg='导入完成！\n成功: '+res.stats.success+'\n重复: '+res.stats.duplicate+'\n失败: '+res.stats.failed;openAlert(msg);await fetchCustomers();render();document.body.removeChild(overlay)}catch(e){console.error(e);openAlert('导入发生错误: '+(e.message||'未知错误'))}finally{btn.textContent='开始导入';btn.disabled=false}};const close=c('button','btn');close.textContent='取消';close.onclick=()=>document.body.removeChild(overlay);panel.append(title,fields,ta,btn,results,close);overlay.append(panel);document.body.append(overlay)}
function formatDate(ts){const d=new Date(ts);const pad=x=>String(x).padStart(2,'0');return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`}
function render(){const app=q('#app');app.innerHTML='';if(!state.currentUser){const card=c('div','container login-container');card.style.minHeight='100vh';card.style.display='flex';card.style.flexDirection='column';card.style.justifyContent='center';card.style.alignItems='center';card.style.paddingTop='0';const banner=document.createElement('img');banner.className='login-banner';banner.src='assets/login-banner.png';banner.alt='登录横幅';banner.onerror=()=>{banner.style.display='none'};const box=c('div','card login-card');box.style.maxWidth='90%';box.style.margin='0 auto';const syncWidth=()=>{try{const w=Math.round(banner.getBoundingClientRect().width||0);if(w>0){box.style.width=w+'px'}}catch(e){}};banner.onload=syncWidth;try{if(banner.complete&&banner.naturalWidth)syncWidth()}catch(e){}const title=c('div','title');title.textContent='重粉管理后台';const u=c('input','input');u.placeholder='用户名';const p=c('input','input');p.type='password';p.placeholder='密码';const btn=c('button','btn btn-primary');btn.textContent='登录';const err=c('div','sub');err.style.color='red';const submit=()=>{const r=login(u.value,p.value);if(r==='ok'){render()}else{err.textContent=r==='disabled'?'您已被限制登陆':'用户名或密码错误'}};btn.onclick=submit;u.onkeydown=e=>{if(e.key==='Enter')submit()};p.onkeydown=e=>{if(e.key==='Enter')submit()};box.append(title,u,p,btn,err);card.append(banner,box);app.append(card);return}
const user=state.currentUser;const layout=c('div','layout');const sidebar=renderSidebar(user);const content=c('div','content');const container=c('div','container');const header=c('div','header');const left=c('div');const right=c('div','toolbar');const rangeSel=c('select');Object.values(Ranges).forEach(r=>{const o=c('option');o.value=r;o.textContent=r;rangeSel.append(o)});rangeSel.value=state.range;rangeSel.onchange=()=>{state.range=rangeSel.value;render()};const dd=c('div','dropdown');const roleText=user.role===Roles.SUPER?'超级管理员':user.role===Roles.ADMIN?'管理员':'运营';const toggle=c('button','btn');toggle.textContent=roleText+' '+user.display_name;const menu=c('div','dropdown-menu');const itemPwd=c('button','btn');itemPwd.textContent='修改密码';itemPwd.onclick=()=>{const overlay=c('div','modal');const panel=c('div','panel');const t=c('div','title');t.textContent='修改密码';const f1=c('div','field');const l1=c('div','label');l1.textContent='新密码';const i1=c('input','input');i1.type='password';const f2=c('div','field');const l2=c('div','label');l2.textContent='确认密码';const i2=c('input','input');i2.type='password';const tip=c('div','sub');const ok=c('button','btn btn-primary');ok.textContent='确定';const cancel=c('button','btn');cancel.textContent='取消';ok.onclick=()=>{try{if(i1.value!==i2.value){tip.textContent='两次输入不一致';return}updateOwnPassword(user,i1.value);tip.textContent='修改成功';setTimeout(()=>{document.body.removeChild(overlay)},800)}catch(e){tip.textContent=e.message==='weak'?'密码至少6位':'修改失败'}};cancel.onclick=()=>document.body.removeChild(overlay);f1.append(l1,i1);f2.append(l2,i2);panel.append(t,f1,f2,ok,cancel,tip);overlay.append(panel);document.body.append(overlay)};const itemLogout=c('button','btn');itemLogout.textContent='退出';itemLogout.onclick=()=>{logout();render()};menu.append(itemPwd,itemLogout);dd.append(toggle,menu);toggle.onclick=()=>{menu.classList.toggle('show')};right.append(rangeSel,dd);header.append(left,right);container.append(header);
if(state.page==='home'){container.append(renderHome(user))}
if(state.page==='users'){container.append(renderUsers(user))}
if(state.page==='system'){if(user.role===Roles.SUPER){container.append(renderUserMgmtSuperFixed(user))}else if(user.role===Roles.ADMIN){container.append(renderUserMgmtAdmin(user))}}
 content.append(container);layout.append(sidebar,content);app.append(layout);if(state.page==='system'){wireDeleteButtons(app);wireRestrictButtons(app);applySystemScrollLimits(app);if(state.currentUser&&state.currentUser.role===Roles.ADMIN){hideDeleteButtonsForAdmin(app)}}}
function renderInput(op){const card=c('div','card');const title=c('div','title');title.textContent='录入客户';const row1=c('div','row');const chSel=c('select');allowedChannels(op).forEach(ch=>{const o=c('option');o.value=ch.id;o.textContent=ch.name;chSel.append(o)});const phone=c('input','input');phone.placeholder='手机号';phone.inputMode='numeric';phone.oninput=()=>{phone.value=phone.value.replace(/[^0-9+()\-\s]/g,'')};row1.append(chSel);const btn=c('button','btn btn-primary');btn.textContent='提交';const tip=c('div','sub');tip.style.marginTop='8px';phone.onkeydown=e=>{if(e.key==='Enter')btn.click()};btn.onclick=async()=>{try{const res=await createCustomer(phone.value,chSel.value,op.id);if(res.status==='success'){tip.textContent='录入成功';phone.value=''}else{const chName=res.existing_channel_name||'未知渠道';openAlert('该手机号已被 '+chName+' 提交')}await fetchCustomers();await fetchDuplicates();render()}catch(e){tip.textContent='手机号格式不合法'}};const btnBatch=c('button','btn');btnBatch.textContent='批量导入';btnBatch.onclick=()=>openBatchImportModal(op,op.id,chSel.value);card.append(title,row1,phone,btn,btnBatch,tip);return card}
function renderInputAdmin(admin){const card=c('div','card');const title=c('div','title');title.textContent='录入客户';const row=c('div','row');const opSel=c('select');listOperators(admin.id).forEach(o=>{const opt=c('option');opt.value=o.id;opt.textContent=o.display_name;opSel.append(opt)});const chSel=c('select');allowedChannels(admin).forEach(ch=>{const o=c('option');o.value=ch.id;o.textContent=ch.name;chSel.append(o)});row.append(opSel,chSel);const phone=c('input','input');phone.placeholder='手机号';phone.inputMode='numeric';phone.oninput=()=>{phone.value=phone.value.replace(/[^0-9+()\-\s]/g,'')};const btn=c('button','btn btn-primary');btn.textContent='提交';const tip=c('div','sub');tip.style.marginTop='8px';phone.onkeydown=e=>{if(e.key==='Enter')btn.click()};btn.onclick=async()=>{try{const res=await createCustomer(phone.value,chSel.value,opSel.value);if(res.status==='success'){tip.textContent='录入成功';phone.value=''}else{const chName=res.existing_channel_name||'未知渠道';openAlert('该手机号已被 '+chName+' 提交')}await fetchCustomers();await fetchDuplicates();render()}catch(e){tip.textContent='手机号格式不合法'}};const btnBatch=c('button','btn');btnBatch.textContent='批量导入';btnBatch.onclick=()=>openBatchImportModal(admin,null,null);card.append(title,row,phone,btn,btnBatch,tip);return card}
function renderInputSuper(superUser){const card=c('div','card');const title=c('div','title');title.textContent='录入客户';const row=c('div','row');const admSel=c('select');listAdmins().forEach(a=>{const opt=c('option');opt.value=a.id;opt.textContent=a.display_name;admSel.append(opt)});const opSel=c('select');const fillOps=()=>{opSel.innerHTML='';listOperators(admSel.value).forEach(o=>{const opt=c('option');opt.value=o.id;opt.textContent=o.display_name;opSel.append(opt)})};fillOps();admSel.onchange=fillOps;const chSel=c('select');state.channels.filter(ch=>ch.is_active).forEach(ch=>{const o=c('option');o.value=ch.id;o.textContent=ch.name;chSel.append(o)});row.append(admSel,opSel,chSel);const phone=c('input','input');phone.placeholder='手机号';phone.inputMode='numeric';phone.oninput=()=>{phone.value=phone.value.replace(/[^0-9+()\-\s]/g,'')};const btn=c('button','btn btn-primary');btn.textContent='提交';const tip=c('div','sub');tip.style.marginTop='8px';phone.onkeydown=e=>{if(e.key==='Enter')btn.click()};btn.onclick=async()=>{try{const res=await createCustomer(phone.value,chSel.value,opSel.value);if(res.status==='success'){tip.textContent='录入成功';phone.value=''}else{const chName=res.existing_channel_name||'未知渠道';openAlert('该手机号已被 '+chName+' 提交')}await fetchCustomers();await fetchDuplicates();render()}catch(e){tip.textContent='手机号格式不合法'}};const btnBatch=c('button','btn');btnBatch.textContent='批量导入';btnBatch.onclick=()=>openBatchImportModal(superUser,null,null);card.append(title,row,phone,btn,btnBatch,tip);return card}
function renderChannels(admin){const card=c('div','card');const title=c('div','title');title.textContent='渠道';const table=c('table','table');const thead=c('thead');const hr=c('tr');['渠道','创建时间'].forEach(h=>{const th=c('th');th.textContent=h;hr.append(th)});thead.append(hr);table.append(thead);const tbody=c('tbody');allowedChannels(admin).forEach(ch=>{const tr=c('tr');const td1=c('td');td1.textContent=ch.name;const td2=c('td');td2.textContent=formatDate(ch.created_at);tr.append(td1,td2);tbody.append(tr)});table.append(tbody);card.append(title,table);return card}
function renderList(user){const card=c('div','card');const title=c('div','title');title.textContent='客户列表';const tools=c('div','searchbar');const search=c('input','input');search.placeholder='搜索手机号/渠道/运营';search.value=state.usersSearch;search.id='searchInput';const sizeSel=c('select');[20,50,100].forEach(s=>{const o=c('option');o.value=String(s);o.textContent=String(s)+'/页';sizeSel.append(o)});sizeSel.value=String(state.usersPageSize);const exportBtn=c('button','btn export');exportBtn.textContent='导出CSV';tools.append(search,sizeSel);if(user.role===Roles.SUPER)tools.append(exportBtn);card.append(title,tools);const table=c('table','table');const thead=c('thead');const hr=c('tr');const headers=['手机号','渠道','运营','管理员','录入时间'];if(user.role!==Roles.OP)headers.push('被重复次数');headers.forEach(h=>{const th=c('th');th.textContent=h;hr.append(th)});thead.append(hr);table.append(thead);const tbody=c('tbody');let list=customersFor(user);if(search.value){const ql=search.value.toLowerCase();list=list.filter(cu=>{const ch=state.channels.find(x=>x.id===cu.channel_id);const op=state.users.find(u=>u.id===cu.owner_operator_id);const pn='+'+String(cu.phone_normalized||'');const sv=search.value;const svDigits=sv.replace(/\D/g,'');return (pn.includes(sv)||cu.phone_normalized.includes(svDigits)||(ch&&ch.name.toLowerCase().includes(ql))||(op&&op.username.toLowerCase().includes(ql)))})}const total=list.length;const pages=Math.max(1,Math.ceil(total/state.usersPageSize));if(state.usersPage>pages)state.usersPage=pages;const start=(state.usersPage-1)*state.usersPageSize;const pageItems=list.slice(start,start+state.usersPageSize);pageItems.forEach(cust=>{const tr=c('tr');tr.style.cursor='pointer';const td1=c('td');td1.textContent='+'+String(cust.phone_normalized||'');const td2=c('td');const ch=state.channels.find(ch=>ch.id===cust.channel_id);td2.textContent=ch?ch.name:'';const tdOp=c('td');const op=state.users.find(u=>u.id===cust.owner_operator_id);tdOp.textContent=op?op.display_name:'(已删除)';const tdAdmin=c('td');const ad=state.users.find(u=>u.id===cust.owner_admin_id);tdAdmin.textContent=ad?ad.display_name:'(已删除)';const td3=c('td');td3.textContent=formatDate(cust.created_at);tr.onclick=()=>openDetail(cust);tr.append(td1,td2,tdOp,tdAdmin,td3);if(user.role!==Roles.OP){const td4=c('td');const cnt=state.duplicates.filter(d=>d.customer_id===cust.id).length;td4.textContent=String(cnt);tr.append(td4)}tbody.append(tr)});table.append(tbody);card.append(table);const pager=c('div','pager');const info=c('div','sub');info.textContent=`共 ${total} 条，页数 ${pages}`;const prev=c('button','btn');prev.textContent='上一页';prev.onclick=()=>{if(state.usersPage>1){state.usersPage--;render()}};const next=c('button','btn');next.textContent='下一页';next.onclick=()=>{if(state.usersPage<pages){state.usersPage++;render()}};pager.append(prev,next,info);card.append(pager);search.oninput=()=>{state.usersSearch=search.value;state.usersPage=1;render();requestAnimationFrame(()=>{const el=document.getElementById('searchInput');if(el){el.value=state.usersSearch;el.focus();try{el.setSelectionRange(el.value.length,el.value.length)}catch(e){}}})};sizeSel.onchange=()=>{state.usersPageSize=parseInt(sizeSel.value,10);state.usersPage=1;render()};exportBtn.onclick=()=>{exportCSV(list)};return card}
function openDetail(cust){const overlay=c('div','modal');const panel=c('div','panel');const title=c('div','title');title.textContent='客户详情';const base=c('div');const cnt=duplicatesFor(cust.id).length;base.innerHTML=`<div class="row"><div>手机号</div><div class="right">${'+'+String(cust.phone_normalized||'')}</div></div><div class="row"><div>渠道</div><div class="right">${(state.channels.find(ch=>ch.id===cust.channel_id)||{}).name||''}</div></div><div class="row"><div>重复次数</div><div class="right">${String(cnt)}</div></div>`;const subTitle=c('div','title');subTitle.style.marginTop='8px';subTitle.textContent='被重复记录';const list=c('div');duplicatesFor(cust.id).sort((a,b)=>a.duplicate_at-b.duplicate_at).forEach(d=>{const who=state.users.find(u=>u.id===d.duplicate_operator_id);const ch=state.channels.find(x=>x.id===d.duplicate_channel_id);const row=c('div','row');row.innerHTML=`<div>${formatDate(d.duplicate_at)}</div><div class="right">重复者: ${who?who.display_name:''}</div><div class="right">渠道: ${ch?ch.name:''}</div>`;list.append(row)});const btn=c('button','btn right');btn.textContent='关闭';btn.onclick=()=>document.body.removeChild(overlay);panel.append(title,base,subTitle,list,btn);overlay.append(panel);document.body.append(overlay)}
function openAdminPicker(onSelect){const overlay=c('div','modal');const panel=c('div','panel');const title=c('div','title');title.textContent='选择对应管理员';const f=c('div','field');const l=c('div','label');l.textContent='管理员用户名';const input=c('input','input');input.placeholder='搜索管理员用户名';const tip=c('div','sub');tip.style.color='red';const list=c('div');function renderAdmins(){list.innerHTML='';const q=(input.value||'').trim().toLowerCase();const admins=listAdmins().filter(a=>a.username.toLowerCase().includes(q));if(admins.length===0){tip.textContent='搜不到现有管理员，请选择现有管理员或创建管理员后重试'}else{tip.textContent=''}admins.forEach(a=>{const row=c('div','row');const name=c('div');name.textContent=a.username;const dn=c('div','right');dn.textContent=a.display_name;const pick=c('button','btn btn-primary');pick.textContent='选择';pick.onclick=()=>{document.body.removeChild(overlay);onSelect(a)};row.append(name,dn,pick);list.append(row)})}input.oninput=renderAdmins;renderAdmins();const cancel=c('button','btn');cancel.textContent='取消';cancel.onclick=()=>document.body.removeChild(overlay);f.append(l,input);panel.append(title,f,tip,list,cancel);overlay.append(panel);document.body.append(overlay)}
function openConfirmDelete(onConfirm){const overlay=c('div','modal');const panel=c('div','panel');const t=c('div','title');t.textContent='确认删除该账号？';const msg=c('div','sub');msg.textContent='删除该账号无法恢复，建议先导出资料';const actions=c('div','row');const cancel=c('button','btn');cancel.textContent='取消';cancel.style.background='#4CAF50';cancel.style.color='white';const ok=c('button','btn');ok.textContent='确认';ok.style.background='#f44336';ok.style.color='white';cancel.onclick=()=>document.body.removeChild(overlay);ok.onclick=()=>{document.body.removeChild(overlay);if(onConfirm)onConfirm()};actions.append(cancel,ok);panel.append(t,msg,actions);overlay.append(panel);document.body.append(overlay)}
function deleteAdminCascade(adminId){const ops=state.users.filter(u=>u.role===Roles.OP&&u.parent_id===adminId).map(u=>u.id);const chs=state.channels.filter(c=>c.owner_admin_id===adminId).map(c=>c.id);const custs=state.customers.filter(c=>c.owner_admin_id===adminId||ops.includes(c.owner_operator_id)||chs.includes(c.channel_id));const custIds=new Set(custs.map(x=>x.id));state.customers=state.customers.filter(c=>!custIds.has(c.id));state.duplicates=state.duplicates.filter(d=>!custIds.has(d.customer_id)&&!ops.includes(d.duplicate_operator_id)&&!ops.includes(d.first_owner_id)&&!chs.includes(d.duplicate_channel_id));state.channels=state.channels.filter(c=>c.owner_admin_id!==adminId);saveChannels();state.users=state.users.filter(u=>u.id!==adminId&&u.parent_id!==adminId);saveUsers();saveCustomers()}
function deleteOperatorCascade(opId){const custs=state.customers.filter(c=>c.owner_operator_id===opId);const custIds=new Set(custs.map(x=>x.id));const chSet=new Set(custs.map(x=>x.channel_id));state.customers=state.customers.filter(c=>!custIds.has(c.id));state.duplicates=state.duplicates.filter(d=>!custIds.has(d.customer_id)&&d.duplicate_operator_id!==opId&&d.first_owner_id!==opId&&!chSet.has(d.duplicate_channel_id));state.users=state.users.filter(u=>u.id!==opId);saveUsers();saveCustomers()}
function deleteChannelCascade(channelId){const custs=state.customers.filter(c=>c.channel_id===channelId);const custIds=new Set(custs.map(x=>x.id));state.customers=state.customers.filter(c=>!custIds.has(c.id));state.duplicates=state.duplicates.filter(d=>!custIds.has(d.customer_id)&&d.duplicate_channel_id!==channelId);state.channels=state.channels.filter(c=>c.id!==channelId);saveChannels();saveCustomers()}
function wireDeleteButtons(container){const btns=container.querySelectorAll('button.btn');btns.forEach(b=>{if(b.textContent==='删除'){const td=b.parentElement;const tr=td?td.parentElement:null;const firstTd=tr?tr.querySelector('td'):null;const uname=firstTd?firstTd.textContent:'';const user=state.users.find(u=>u.username===uname);if(user){b.onclick=()=>{openConfirmDelete(async ()=>{try{if(user.role===Roles.ADMIN){await apiDelete('/api/admins/'+user.id)}else{await apiDelete('/api/operators/'+user.id)}await fetchUsers();render()}catch(e){}})}}}})}
function wireRestrictButtons(container){const btns=container.querySelectorAll('button.btn');btns.forEach(b=>{const t=b.textContent||'';if(t==='限制'||t==='启用'){const tr=b.closest('tr');const firstTd=tr?tr.querySelector('td'):null;const uname=firstTd?firstTd.textContent:'';const user=state.users.find(u=>u.username===uname);if(user){b.onclick=()=>{if(t==='限制'){openConfirmRestrict(async ()=>{try{await apiPatch('/api/users/'+user.id,{is_active:false});await fetchUsers();render()}catch(e){}})}else{(async()=>{try{await apiPatch('/api/users/'+user.id,{is_active:true});await fetchUsers();render()}catch(e){}})()}}}}})}
function hideDeleteButtonsForAdmin(root){const btns=root.querySelectorAll('button.btn');btns.forEach(b=>{if(b.textContent==='删除'){b.style.display='none'}})}
function openConfirmRestrict(onConfirm){const overlay=c('div','modal');const panel=c('div','panel');const t=c('div','title');t.textContent='确认限制该账号？';const msg=c('div','sub');msg.textContent='限制该账号后将无法登陆后台';const actions=c('div','row');const cancel=c('button','btn');cancel.textContent='取消';cancel.style.background='#4CAF50';cancel.style.color='white';const ok=c('button','btn');ok.textContent='确认';ok.style.background='#f44336';ok.style.color='white';cancel.onclick=()=>document.body.removeChild(overlay);ok.onclick=()=>{document.body.removeChild(overlay);if(onConfirm)onConfirm()};actions.append(cancel,ok);panel.append(t,msg,actions);overlay.append(panel);document.body.append(overlay)}
function applySystemScrollLimits(root){
  const cards=root.querySelectorAll('.card');
  cards.forEach(card=>{
    const titles=card.querySelectorAll('.title');
    titles.forEach(tt=>{
      const txt=tt.textContent||'';
      if(txt==='管理员列表'||txt==='运营列表'||txt==='渠道列表'||txt==='我的运营列表'){
        let el=tt.nextElementSibling;
        while(el&&el.tagName&&el.tagName.toLowerCase()!=='table'){
          el=el.nextElementSibling;
        }
        if(el&&el.tagName&&el.tagName.toLowerCase()==='table'){
          let desired='scroll-tbody-1';
          if(txt==='运营列表')desired='scroll-tbody-3';
          if(txt==='渠道列表')desired='scroll-tbody-2';
          if(txt==='我的运营列表')desired='scroll-tbody-2';
          const cls=el.className||'';
          el.className=(cls.replace(/\bscroll-tbody-\d\b/g,'')+' '+desired).trim();
          if(txt==='运营列表'||txt==='我的运营列表'||txt==='渠道列表'){
            const tb=el.querySelector('tbody');
            const tr=tb?tb.querySelector('tr'):null;
            const rh=tr?Math.round(tr.getBoundingClientRect().height):40;
            const rows=txt==='运营列表'?3:2;
            if(tb){tb.style.maxHeight=(rh*rows)+'px';tb.style.overflowY=(txt==='运营列表'?'auto':'scroll');tb.style.display='block';tb.style.width='100%'}
            const th=el.querySelector('thead');
            if(th){th.style.display='table';th.style.width='100%'}
          }
        }
      }
    });
  });
}
function renderUserMgmtSuperFixed(superUser){const wrap=c('div','grid');
const card0=c('div','card');const t0=c('div','title');t0.textContent='创建渠道';const f0n=c('div','field');const l0n=c('div','label');l0n.textContent='渠道名称';const i0n=c('input','input');const b0=c('button','btn btn-primary');const tip0=c('div','sub');b0.textContent='创建渠道';b0.onclick=()=>{const nm=(i0n.value||'').trim();if(!nm){tip0.textContent='请输入完整信息';openAlert('请输入完整信息');return}openAdminPicker(async (adm)=>{try{await createChannel({name:nm,creator_id:superUser.id,owner_admin_id:adm.id});await fetchChannels();render();openAlert('创建成功');requestAnimationFrame(()=>highlightChannelByName(nm));i0n.value=''}catch(e){if(e.message==='exists'){await fetchChannels();render();const isActive=(e.data&&e.data.is_active)?true:false;openAlert(isActive?'渠道已存在，请先删除后再创建':'渠道已存在被限制，请启用或更换名字后重建');requestAnimationFrame(()=>highlightChannelByName(nm))}else{tip0.textContent='创建失败，请稍后重试';openAlert('创建失败，请稍后重试')}}})};f0n.append(l0n,i0n);card0.append(t0,f0n,b0,tip0);
const card1=c('div','card');const t1=c('div','title');t1.textContent='创建管理员';const f1u=c('div','field');const l1u=c('div','label');l1u.textContent='用户名';const i1u=c('input','input');const f1n=c('div','field');const l1n=c('div','label');l1n.textContent='昵称';const i1n=c('input','input');const f1p=c('div','field');const l1p=c('div','label');l1p.textContent='初始密码';const i1p=c('input','input');i1p.type='password';const b1=c('button','btn btn-primary');const tip1=c('div','sub');b1.textContent='创建管理员';b1.onclick=async ()=>{try{await createAdmin({username:i1u.value,display_name:i1n.value,password:i1p.value});tip1.textContent='创建成功';i1u.value='';i1n.value='';i1p.value='';await fetchUsers();render()}catch(e){tip1.textContent=e.message==='exists'?'用户名已存在':'请输入完整信息'}};f1u.append(l1u,i1u);f1n.append(l1n,i1n);f1p.append(l1p,i1p);card1.append(t1,f1u,f1n,f1p,b1,tip1);
const card2=c('div','card');const t2=c('div','title');t2.textContent='创建运营';const f2a=c('div','field');const l2a=c('div','label');l2a.textContent='归属管理员';const s2a=c('select');listAdmins().forEach(a=>{const o=c('option');o.value=a.id;o.textContent=a.display_name;s2a.append(o)});const f2u=c('div','field');const l2u=c('div','label');l2u.textContent='用户名';const i2u=c('input','input');const f2n=c('div','field');const l2n=c('div','label');l2n.textContent='昵称';const i2n=c('input','input');const f2p=c('div','field');const l2p=c('div','label');l2p.textContent='初始密码';const i2p=c('input','input');i2p.type='password';const b2=c('button','btn btn-primary');const tip2=c('div','sub');b2.textContent='创建运营';b2.onclick=async ()=>{try{await createOperator({username:i2u.value,display_name:i2n.value,password:i2p.value,owner_admin_id:s2a.value});tip2.textContent='创建成功';i2u.value='';i2n.value='';i2p.value='';await fetchUsers();render()}catch(e){tip2.textContent=e.message==='exists'?'用户名已存在':'请输入完整信息'}};f2a.append(l2a,s2a);f2u.append(l2u,i2u);f2n.append(l2n,i2n);f2p.append(l2p,i2p);card2.append(t2,f2a,f2u,f2n,f2p,b2,tip2);
const card3=c('div','card');const t3=c('div','title');t3.textContent='管理员列表';const table=c('table','table sys-users');const thead=c('thead');const hr=c('tr');['用户名','昵称','运营数','操作'].forEach(h=>{const th=c('th');th.textContent=h;hr.append(th)});thead.append(hr);table.append(thead);const tbody=c('tbody');listAdmins().forEach(a=>{const tr=c('tr');const td1=c('td');td1.textContent=a.username;const td2=c('td');td2.textContent=a.display_name;const td3=c('td');td3.textContent=String(listOperators(a.id).length);const td4=c('td','ops');const del=c('button','btn');del.textContent='删除';del.classList.add('btn-delete');del.onclick=()=>{state.users=state.users.filter(u=>u.id!==a.id);saveUsers();render()};const chg=c('button','btn');chg.textContent='修改密码';chg.classList.add('btn-change');chg.onclick=()=>{const overlay=c('div','modal');const panel=c('div','panel');const tt=c('div','title');tt.textContent='修改管理员密码';const f1=c('div','field');const l1=c('div','label');l1.textContent='新密码';const i1=c('input','input');i1.type='password';const f2=c('div','field');const l2=c('div','label');l2.textContent='确认密码';const i2=c('input','input');i2.type='password';const tip=c('div','sub');const ok=c('button','btn btn-primary');ok.textContent='确定';const cancel=c('button','btn');cancel.textContent='取消';ok.onclick=()=>{try{if(i1.value!==i2.value){tip.textContent='两次输入不一致';return}updatePasswordByAdmin(superUser,a.id,i1.value);tip.textContent='修改成功';setTimeout(()=>{document.body.removeChild(overlay)},800)}catch(e){tip.textContent=e.message==='weak'?'密码至少6位':'无权限或用户不存在'}};cancel.onclick=()=>document.body.removeChild(overlay);f1.append(l1,i1);f2.append(l2,i2);panel.append(tt,f1,f2,ok,cancel,tip);overlay.append(panel);document.body.append(overlay)};const toggle=c('button','btn');toggle.textContent=a.is_active?'限制':'启用';toggle.classList.add('btn-toggle');toggle.style.color='white';toggle.style.background=a.is_active?'#f44336':'#4CAF50';toggle.onclick=()=>{if(a.is_active){openConfirmRestrict(()=>{a.is_active=false;saveUsers();render()})}else{a.is_active=true;saveUsers();render()}};td4.append(del,chg,toggle);tr.append(td1,td2,td3,td4);tbody.append(tr)});table.append(tbody);card3.append(t3,table);
const tOps=c('div','title');tOps.textContent='运营列表';const tableOps=c('table','table sys-users scroll-tbody-3');const theadOps=c('thead');const hrOps=c('tr');['用户名','昵称','归属管理员','操作'].forEach(h=>{const th=c('th');th.textContent=h;hrOps.append(th)});theadOps.append(hrOps);tableOps.append(theadOps);const tbodyOps=c('tbody');state.users.filter(u=>u.role===Roles.OP).forEach(o=>{const tr=c('tr');const td1=c('td');td1.textContent=o.username;const td2=c('td');td2.textContent=o.display_name;const td3=c('td');const adm=state.users.find(u=>u.id===o.parent_id);td3.textContent=adm?adm.display_name:'';const td4=c('td','ops');const del=c('button','btn');del.textContent='删除';del.classList.add('btn-delete');del.onclick=()=>{state.users=state.users.filter(u=>u.id!==o.id);saveUsers();render()};const chg=c('button','btn');chg.textContent='修改密码';chg.classList.add('btn-change');chg.onclick=()=>{const overlay=c('div','modal');const panel=c('div','panel');const tt=c('div','title');tt.textContent='修改运营密码';const f1=c('div','field');const l1=c('div','label');l1.textContent='新密码';const i1=c('input','input');i1.type='password';const f2=c('div','field');const l2=c('div','label');l2.textContent='确认密码';const i2=c('input','input');i2.type='password';const tip=c('div','sub');const ok=c('button','btn btn-primary');ok.textContent='确定';const cancel=c('button','btn');cancel.textContent='取消';ok.onclick=()=>{try{if(i1.value!==i2.value){tip.textContent='两次输入不一致';return}updatePasswordByAdmin(superUser,o.id,i1.value);tip.textContent='修改成功';setTimeout(()=>{document.body.removeChild(overlay)},800)}catch(e){tip.textContent=e.message==='weak'?'密码至少6位':'无权限或用户不存在'}};cancel.onclick=()=>document.body.removeChild(overlay);f1.append(l1,i1);f2.append(l2,i2);panel.append(tt,f1,f2,ok,cancel,tip);overlay.append(panel);document.body.append(overlay)};const toggle=c('button','btn');toggle.textContent=o.is_active?'限制':'启用';toggle.classList.add('btn-toggle');toggle.style.color='white';toggle.style.background=o.is_active?'#f44336':'#4CAF50';toggle.onclick=()=>{if(o.is_active){openConfirmRestrict(()=>{o.is_active=false;saveUsers();render()})}else{o.is_active=true;saveUsers();render()}};td4.append(del,chg,toggle);tr.append(td1,td2,td3,td4);tbodyOps.append(tr)});tableOps.append(tbodyOps);card3.append(tOps,tableOps);
const card4=c('div','card');const t4=c('div','title');t4.textContent='渠道列表';const tableCh=c('table','table');const theadCh=c('thead');const hrCh=c('tr');['渠道','创建时间','操作'].forEach(h=>{const th=c('th');th.textContent=h;hrCh.append(th)});theadCh.append(hrCh);tableCh.append(theadCh);const tbodyCh=c('tbody');state.channels.forEach(ch=>{const tr=c('tr');const td1=c('td');td1.textContent=ch.name;const td3=c('td');td3.textContent=formatDate(ch.created_at);const tdOps=c('td','ops');const bR=c('button','btn');bR.textContent=ch.is_active?'限制':'启用';bR.style.color='white';bR.style.background=ch.is_active?'#f44336':'#4CAF50';bR.onclick=()=>{if(ch.is_active){openConfirmRestrict(async ()=>{try{await apiPatch('/api/channels/'+ch.id,{is_active:false});await fetchChannels();render()}catch(e){}})}else{(async()=>{try{await apiPatch('/api/channels/'+ch.id,{is_active:true});await fetchChannels();render()}catch(e){}})()}};const bD=c('button','btn');bD.textContent='删除';bD.onclick=()=>{openConfirmDelete(async ()=>{try{await apiDelete('/api/channels/'+ch.id);await fetchChannels();render()}catch(e){}})};tdOps.append(bR,bD);tr.append(td1,td3,tdOps);tbodyCh.append(tr)});tableCh.append(tbodyCh);card4.append(t4,tableCh);card0.append(t4,tableCh);
wrap.append(card0,card1,card3,card2);return wrap}
function renderUserMgmtSuper(superUser){const wrap=c('div','grid');
const card0=c('div','card');const t0=c('div','title');t0.textContent='创建渠道';const f0n=c('div','field');const l0n=c('div','label');l0n.textContent='渠道名称';const i0n=c('input','input');const b0=c('button','btn btn-primary');const tip0=c('div','sub');b0.textContent='创建渠道';b0.onclick=()=>{const nm=(i0n.value||'').trim();if(!nm){tip0.textContent='请输入完整信息';showToast('请输入完整信息');return}openAdminPicker(async (adm)=>{try{await createChannel({name:nm,creator_id:superUser.id,owner_admin_id:adm.id});showToast('创建成功');i0n.value='';await fetchChannels();render()}catch(e){if(e.message==='exists'){showToast('渠道已存在，请先删除后再创建');await fetchChannels();render()}else{tip0.textContent='创建失败，请稍后重试';showToast('创建失败，请稍后重试')}}})};f0n.append(l0n,i0n);card0.append(t0,f0n,b0,tip0);
const card1=c('div','card');const t1=c('div','title');t1.textContent='创建管理员';const f1u=c('div','field');const l1u=c('div','label');l1u.textContent='用户名';const i1u=c('input','input');const f1n=c('div','field');const l1n=c('div','label');l1n.textContent='昵称';const i1n=c('input','input');const f1p=c('div','field');const l1p=c('div','label');l1p.textContent='初始密码';const i1p=c('input','input');i1p.type='password';const b1=c('button','btn btn-primary');const tip1=c('div','sub');b1.textContent='创建管理员';b1.onclick=async ()=>{try{await createAdmin({username:i1u.value,display_name:i1n.value,password:i1p.value});tip1.textContent='创建成功';i1u.value='';i1n.value='';i1p.value='';await fetchUsers();render()}catch(e){tip1.textContent=e.message==='exists'?'用户名已存在':'请输入完整信息'}};f1u.append(l1u,i1u);f1n.append(l1n,i1n);f1p.append(l1p,i1p);card1.append(t1,f1u,f1n,f1p,b1,tip1);
const card2=c('div','card');const t2=c('div','title');t2.textContent='创建运营';const f2a=c('div','field');const l2a=c('div','label');l2a.textContent='归属管理员';const s2a=c('select');listAdmins().forEach(a=>{const o=c('option');o.value=a.id;o.textContent=a.display_name; s2a.append(o)});const f2u=c('div','field');const l2u=c('div','label');l2u.textContent='用户名';const i2u=c('input','input');const f2n=c('div','field');const l2n=c('div','label');l2n.textContent='昵称';const i2n=c('input','input');const f2p=c('div','field');const l2p=c('div','label');l2p.textContent='初始密码';const i2p=c('input','input');i2p.type='password';const b2=c('button','btn btn-primary');const tip2=c('div','sub');b2.textContent='创建运营';b2.onclick=async ()=>{try{await createOperator({username:i2u.value,display_name:i2n.value,password:i2p.value,owner_admin_id:s2a.value});tip2.textContent='创建成功';i2u.value='';i2n.value='';i2p.value='';await fetchUsers();render()}catch(e){tip2.textContent=e.message==='exists'?'用户名已存在':'请输入完整信息'}};f2a.append(l2a,s2a);f2u.append(l2u,i2u);f2n.append(l2n,i2n);f2p.append(l2p,i2p);card2.append(t2,f2a,f2u,f2n,f2p,b2,tip2);
const card3=c('div','card');const t3=c('div','title');t3.textContent='管理员列表';const table=c('table','table');const thead=c('thead');const hr=c('tr');['用户名','昵称','运营数','操作'].forEach(h=>{const th=c('th');th.textContent=h;hr.append(th)});thead.append(hr);table.append(thead);const tbody=c('tbody');listAdmins().forEach(a=>{const tr=c('tr');const td1=c('td');td1.textContent=a.username;const td2=c('td');td2.textContent=a.display_name;const td3=c('td');td3.textContent=String(listOperators(a.id).length);const td4=c('td','ops');const del=c('button','btn');del.textContent='删除';del.classList.add('btn-delete');del.onclick=()=>{state.users=state.users.filter(u=>u.id!==a.id);saveUsers();render()};const chg=c('button','btn');chg.textContent='修改密码';chg.classList.add('btn-change');chg.onclick=()=>{const overlay=c('div','modal');const panel=c('div','panel');const t=c('div','title');t.textContent='修改管理员密码';const f1=c('div','field');const l1=c('div','label');l1.textContent='新密码';const i1=c('input','input');i1.type='password';const f2=c('div','field');const l2=c('div','label');l2.textContent='确认密码';const i2=c('input','input');i2.type='password';const tip=c('div','sub');const ok=c('button','btn btn-primary');ok.textContent='确定';const cancel=c('button','btn');cancel.textContent='取消';ok.onclick=()=>{try{if(i1.value!==i2.value){tip.textContent='两次输入不一致';return}updatePasswordByAdmin(superUser,a.id,i1.value);tip.textContent='修改成功';setTimeout(()=>{document.body.removeChild(overlay)},800)}catch(e){tip.textContent=e.message==='弱'?'密码至少6位':'无权限或用户不存在'}};cancel.onclick=()=>document.body.removeChild(overlay);f1.append(l1,i1);f2.append(l2,i2);panel.append(t,f1,f2,ok,cancel,tip);overlay.append(panel);document.body.append(overlay)};const toggle=c('button','btn');toggle.textContent=a.is_active?'限制':'启用';toggle.classList.add('btn-toggle');toggle.style.color='white';toggle.style.background=a.is_active?'#f44336':'#4CAF50';toggle.onclick=()=>{if(a.is_active){openConfirmRestrict(()=>{a.is_active=false;saveUsers();render()})}else{a.is_active=true;saveUsers();render()}};td4.append(del,chg,toggle);tr.append(td1,td2,td3,td4);tbody.append(tr)});table.append(tbody);card3.append(t3,table);
const cardOps=c('div','card');const tOps=c('div','title');tOps.textContent='运营列表';const tableOps=c('table','table sys-users scroll-tbody-3');const theadOps=c('thead');const hrOps=c('tr');['用户名','昵称','归属管理员','操作'].forEach(h=>{const th=c('th');th.textContent=h;hrOps.append(th)});theadOps.append(hrOps);tableOps.append(theadOps);const tbodyOps=c('tbody');state.users.filter(u=>u.role===Roles.OP).forEach(o=>{const tr=c('tr');const td1=c('td');td1.textContent=o.username;const td2=c('td');td2.textContent=o.display_name;const td3=c('td');const adm=state.users.find(u=>u.id===o.parent_id);td3.textContent=adm?adm.display_name:'';const td4=c('td','ops');const del=c('button','btn');del.textContent='删除';del.classList.add('btn-delete');del.onclick=()=>{state.users=state.users.filter(u=>u.id!==o.id);saveUsers();render()};const chg=c('button','btn');chg.textContent='修改密码';chg.classList.add('btn-change');chg.onclick=()=>{const overlay=c('div','modal');const panel=c('div','panel');const t=c('div','title');t.textContent='修改运营密码';const f1=c('div','field');const l1=c('div','label');l1.textContent='新密码';const i1=c('input','input');i1.type='password';const f2=c('div','field');const l2=c('div','label');l2.textContent='确认密码';const i2=c('input','input');i2.type='password';const tip=c('div','sub');const ok=c('button','btn btn-primary');ok.textContent='确定';const cancel=c('button','btn');cancel.textContent='取消';ok.onclick=()=>{try{if(i1.value!==i2.value){tip.textContent='两次输入不一致';return}updatePasswordByAdmin(superUser,o.id,i1.value);tip.textContent='修改成功';setTimeout(()=>{document.body.removeChild(overlay)},800)}catch(e){tip.textContent=e.message==='weak'?'密码至少6位':'无权限或用户不存在'}};cancel.onclick=()=>document.body.removeChild(overlay);f1.append(l1,i1);f2.append(l2,i2);panel.append(t,f1,f2,ok,cancel,tip);overlay.append(panel);document.body.append(overlay)};const toggle=c('button','btn');toggle.textContent=o.is_active?'限制':'启用';toggle.classList.add('btn-toggle');toggle.style.color='white';toggle.style.background=o.is_active?'#f44336':'#4CAF50';toggle.onclick=()=>{if(o.is_active){openConfirmRestrict(()=>{o.is_active=false;saveUsers();render()})}else{o.is_active=true;saveUsers();render()}};td4.append(del,chg,toggle);tr.append(td1,td2,td3,td4);tbodyOps.append(tr)});tableOps.append(tbodyOps);cardOps.append(tOps,tableOps);card3.append(tOps,tableOps);
const card4=c('div','card');const t4=c('div','title');t4.textContent='渠道列表';const tableCh=c('table','table');const theadCh=c('thead');const hrCh=c('tr');['渠道','创建时间','操作'].forEach(h=>{const th=c('th');th.textContent=h;hrCh.append(th)});theadCh.append(hrCh);tableCh.append(theadCh);const tbodyCh=c('tbody');state.channels.forEach(ch=>{const tr=c('tr');const td1=c('td');td1.textContent=ch.name;const td3=c('td');td3.textContent=formatDate(ch.created_at);const tdOps=c('td','ops');const bR=c('button','btn');bR.textContent=ch.is_active?'限制':'启用';bR.style.color='white';bR.style.background=ch.is_active?'#f44336':'#4CAF50';bR.onclick=()=>{if(ch.is_active){openConfirmRestrict(async ()=>{try{await apiPatch('/api/channels/'+ch.id,{is_active:false});await fetchChannels();render()}catch(e){}})}else{(async()=>{try{await apiPatch('/api/channels/'+ch.id,{is_active:true});await fetchChannels();render()}catch(e){}})()}};const bD=c('button','btn');bD.textContent='删除';bD.onclick=()=>{openConfirmDelete(async ()=>{try{await apiDelete('/api/channels/'+ch.id);await fetchChannels();render()}catch(e){}})};tdOps.append(bR,bD);tr.append(td1,td3,tdOps);tbodyCh.append(tr)});tableCh.append(tbodyCh);card4.append(t4,tableCh);card0.append(t4,tableCh);
wrap.append(card0,card1,card3,card2);return wrap}
function renderUserMgmtAdmin(adminUser){const wrap=c('div','grid');
const card0=c('div','card');const t0=c('div','title');t0.textContent='创建渠道';const f0n=c('div','field');const l0n=c('div','label');l0n.textContent='渠道名称';const i0n=c('input','input');const b0=c('button','btn btn-primary');const tip0=c('div','sub');b0.textContent='创建渠道';b0.onclick=()=>{const nm=(i0n.value||'').trim();if(!nm){tip0.textContent='请输入完整信息';openAlert('请输入完整信息');return}(async()=>{try{await createChannel({name:nm,creator_id:adminUser.id,owner_admin_id:adminUser.id});await fetchChannels();render();openAlert('创建成功');requestAnimationFrame(()=>highlightChannelByName(nm));i0n.value=''}catch(e){if(e.message==='exists'){await fetchChannels();render();const isActive=(e.data&&e.data.is_active)?true:false;openAlert(isActive?'渠道已被其他管理员或超级管理员创建，请更换命名后重建':'渠道已被其他管理员或超级管理员创建，但已限制，请启用或更换命名后重建');requestAnimationFrame(()=>highlightChannelByName(nm))}else{tip0.textContent='创建失败，请稍后重试';openAlert('创建失败，请稍后重试')}}})()};f0n.append(l0n,i0n);card0.append(t0,f0n,b0,tip0);
const card1=c('div','card');const t1=c('div','title');t1.textContent='创建运营';const f1u=c('div','field');const l1u=c('div','label');l1u.textContent='用户名';const i1u=c('input','input');const f1n=c('div','field');const l1n=c('div','label');l1n.textContent='昵称';const i1n=c('input','input');const f1p=c('div','field');const l1p=c('div','label');l1p.textContent='初始密码';const i1p=c('input','input');i1p.type='password';const b1=c('button','btn btn-primary');const tip1=c('div','sub');b1.textContent='创建运营';b1.onclick=async ()=>{try{await createOperator({username:i1u.value,display_name:i1n.value,password:i1p.value,owner_admin_id:adminUser.id});tip1.textContent='创建成功';i1u.value='';i1n.value='';i1p.value='';await fetchUsers();render()}catch(e){tip1.textContent=e.message==='exists'?'用户名已存在':'请输入完整信息'}};f1u.append(l1u,i1u);f1n.append(l1n,i1n);f1p.append(l1p,i1p);card1.append(t1,f1u,f1n,f1p,b1,tip1);
const card2=c('div','card');const t2=c('div','title');t2.textContent='我的运营列表';const table=c('table','table');const thead=c('thead');const hr=c('tr');['用户名','昵称','操作'].forEach(h=>{const th=c('th');th.textContent=h;hr.append(th)});thead.append(hr);table.append(thead);const tbody=c('tbody');listOperators(adminUser.id).forEach(o=>{const tr=c('tr');const td1=c('td');td1.textContent=o.username;const td2=c('td');td2.textContent=o.display_name;const td3=c('td','ops');const del=c('button','btn');del.textContent='删除';del.classList.add('btn-delete');del.onclick=()=>{state.users=state.users.filter(u=>u.id!==o.id);render()};const chg=c('button','btn');chg.textContent='修改密码';chg.classList.add('btn-change');chg.onclick=()=>{const overlay=c('div','modal');const panel=c('div','panel');const t=c('div','title');t.textContent='修改运营密码';const f1=c('div','field');const l1=c('div','label');l1.textContent='新密码';const i1=c('input','input');i1.type='password';const f2=c('div','field');const l2=c('div','label');l2.textContent='确认密码';const i2=c('input','input');i2.type='password';const tip=c('div','sub');const ok=c('button','btn btn-primary');ok.textContent='确定';const cancel=c('button','btn');cancel.textContent='取消';ok.onclick=()=>{try{if(i1.value!==i2.value){tip.textContent='两次输入不一致';return}updatePasswordByAdmin(adminUser,o.id,i1.value);tip.textContent='修改成功';setTimeout(()=>{document.body.removeChild(overlay)},800)}catch(e){tip.textContent=e.message==='weak'?'密码至少6位':'无权限或用户不存在'}};cancel.onclick=()=>document.body.removeChild(overlay);f1.append(l1,i1);f2.append(l2,i2);panel.append(t,f1,f2,ok,cancel,tip);overlay.append(panel);document.body.append(overlay)};const toggle=c('button','btn');toggle.textContent=o.is_active?'限制':'启用';toggle.classList.add('btn-toggle');toggle.style.color='white';toggle.style.background=o.is_active?'#f44336':'#4CAF50';toggle.onclick=()=>{if(o.is_active){openConfirmRestrict(()=>{o.is_active=false;render()})}else{o.is_active=true;render()}};td3.append(del,chg,toggle);tr.append(td1,td2,td3);tbody.append(tr)});table.append(tbody);card2.append(t2,table);
const card3=c('div','card');const t3=c('div','title');t3.textContent='渠道列表';const tableCh=c('table','table');const theadCh=c('thead');const hrCh=c('tr');['渠道','创建时间','操作'].forEach(h=>{const th=c('th');th.textContent=h;hrCh.append(th)});theadCh.append(hrCh);tableCh.append(theadCh);const tbodyCh=c('tbody');state.channels.forEach(ch=>{if(ch.owner_admin_id!==adminUser.id)return;const tr=c('tr');const td1=c('td');td1.textContent=ch.name;const td3=c('td');td3.textContent=formatDate(ch.created_at);const tdOps=c('td','ops');const bR=c('button','btn');bR.textContent=ch.is_active?'限制':'启用';bR.style.color='white';bR.style.background=ch.is_active?'#f44336':'#4CAF50';bR.onclick=()=>{if(ch.is_active){openConfirmRestrict(async ()=>{try{await apiPatch('/api/channels/'+ch.id,{is_active:false});await fetchChannels();render()}catch(e){}})}else{(async()=>{try{await apiPatch('/api/channels/'+ch.id,{is_active:true});await fetchChannels();render()}catch(e){}})()}};tdOps.append(bR);tr.append(td1,td3,tdOps);tbodyCh.append(tr)});tableCh.append(tbodyCh);card3.append(t3,tableCh);card0.append(t3,tableCh);
wrap.append(card0,card1,card2);return wrap}
function renderSidebar(user){const side=c('div','sidebar');const nav=c('div','nav');const i1=c('a','nav-item');i1.href='#';i1.textContent='首页';if(state.page==='home')i1.classList.add('active');i1.onclick=e=>{e.preventDefault();state.page='home';render()};const i2=c('a','nav-item');i2.href='#';i2.textContent='用户详情';if(state.page==='users')i2.classList.add('active');i2.onclick=e=>{e.preventDefault();state.page='users';render()};const i3=c('a','nav-item');i3.href='#';i3.textContent='系统管理';if(state.page==='system')i3.classList.add('active');i3.onclick=e=>{e.preventDefault();state.page='system';render()};nav.append(i1,i2);if(user.role!==Roles.OP)nav.append(i3);side.append(nav);return side}
function renderHome(user){const wrap=c('div');const s=stats(user,state.range);const metrics=c('div','metrics');[['录入',s.total_input],['重复',s.duplicate_cnt],['有效',s.valid_cnt]].forEach(([t,v])=>{const m=c('div','metric');const tt=c('div','sub');tt.textContent=t;const vv=c('div','title');vv.textContent=String(v);m.append(tt,vv);metrics.append(m)});wrap.append(metrics);if(user.role===Roles.OP){wrap.append(renderInput(user))}else if(user.role===Roles.ADMIN){wrap.append(renderInputAdmin(user))}else{wrap.append(renderInputSuper(user))}if(user.role!==Roles.OP){const cardCh=c('div','card');const tCh=c('div','title');tCh.textContent='渠道汇总';const tableCh=c('table','table');const theadCh=c('thead');const hrCh=c('tr');['渠道','录入','重复','有效'].forEach(h=>{const th=c('th');th.textContent=h;hrCh.append(th)});theadCh.append(hrCh);tableCh.append(theadCh);const tbodyCh=c('tbody');const chs=user.role===Roles.SUPER? state.channels : allowedChannels(user);chs.forEach(ch=>{const totals=channelStats(user,ch.id);const tr=c('tr');const td1=c('td');td1.textContent=ch.name;const td2=c('td');td2.textContent=String(totals.total_input);const td3=c('td');td3.textContent=String(totals.duplicate_cnt);const td4=c('td');td4.textContent=String(totals.valid_cnt);tr.append(td1,td2,td3,td4);tbodyCh.append(tr)});tableCh.append(tbodyCh);cardCh.append(tCh,tableCh);wrap.append(cardCh)}if(user.role===Roles.SUPER){const cardAdm=c('div','card');const tAdm=c('div','title');tAdm.textContent='管理员汇总';const tableAdm=c('table','table');const theadAdm=c('thead');const hrAdm=c('tr');['管理员','录入','重复','有效'].forEach(h=>{const th=c('th');th.textContent=h;hrAdm.append(th)});theadAdm.append(hrAdm);tableAdm.append(theadAdm);const tbodyAdm=c('tbody');listAdmins().forEach(a=>{const totals=adminStats(a.id);const tr=c('tr');const td1=c('td');td1.textContent=a.display_name;const td2=c('td');td2.textContent=String(totals.total_input);const td3=c('td');td3.textContent=String(totals.duplicate_cnt);const td4=c('td');td4.textContent=String(totals.valid_cnt);tr.append(td1,td2,td3,td4);tbodyAdm.append(tr)});tableAdm.append(tbodyAdm);cardAdm.append(tAdm,tableAdm);wrap.append(cardAdm)}return wrap}
function channelStats(user,channelId){const now=Date.now();const dateFilter=d=>state.range===Ranges.ALL?true:state.range===Ranges.DAILY?inSameDay(d,now):state.range===Ranges.WEEKLY?inSameWeek(d,now):inSameMonth(d,now);const cs=customersFor(user).filter(c=>c.channel_id===channelId&&dateFilter(c.created_at));const ds=state.duplicates.filter(d=>d.duplicate_channel_id===channelId&&dateFilter(d.duplicate_at)&&duplicateScopeMatch(user,d));const total_input=cs.length+ds.length;const duplicate_cnt=ds.length;const set=new Set(cs.map(c=>c.phone_hash));const valid_cnt=set.size;return{total_input,duplicate_cnt,valid_cnt}}
function adminStats(adminId){const now=Date.now();const dateFilter=d=>state.range===Ranges.ALL?true:state.range===Ranges.DAILY?inSameDay(d,now):state.range===Ranges.WEEKLY?inSameWeek(d,now):inSameMonth(d,now);const cs=state.customers.filter(c=>c.owner_admin_id===adminId&&dateFilter(c.created_at));const chs=state.channels.filter(ch=>ch.owner_admin_id===adminId).map(ch=>ch.id);const setCh=new Set(chs);const ds=state.duplicates.filter(d=>dateFilter(d.duplicate_at)&&setCh.has(d.duplicate_channel_id));const total_input=cs.length+ds.length;const duplicate_cnt=ds.length;const set=new Set(cs.map(c=>c.phone_hash));const valid_cnt=set.size;return{total_input,duplicate_cnt,valid_cnt}}
function duplicateScopeMatch(user,d){if(user.role===Roles.SUPER)return true;if(user.role===Roles.ADMIN){const ops=listOperators(user.id).map(o=>o.id);const set=new Set(ops);return set.has(d.duplicate_operator_id)}return d.duplicate_operator_id===user.id}
function renderUsers(user){const wrap=c('div');wrap.append(renderList(user));return wrap}
function exportCSV(items){const rows=[["手机号","渠道","运营","管理员","录入时间","被重复次数"]];items.forEach(c=>{const ch=state.channels.find(x=>x.id===c.channel_id);const op=state.users.find(u=>u.id===c.owner_operator_id);const ad=state.users.find(u=>u.id===c.owner_admin_id);const cnt=state.duplicates.filter(d=>d.customer_id===c.id).length;rows.push(['+'+String(c.phone_normalized||''),ch?ch.name:'',op?op.display_name:'',ad?ad.display_name:'',formatDate(c.created_at),String(cnt)])});const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\r\n');const bom='\ufeff';const blob=new Blob([bom,csv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='customers.csv';document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)}
async function main(){try{await genKey();await fetchUsers();await fetchChannels();await fetchCustomers();await fetchDuplicates()}catch(e){}finally{render()}}
main()
function saveChannels(){try{localStorage.setItem('channels',JSON.stringify(state.channels))}catch(e){}}
function loadChannels(){try{const d=localStorage.getItem('channels');if(d){state.channels=JSON.parse(d)}}catch(e){} }
function saveUsers(){try{localStorage.setItem('users',JSON.stringify(state.users))}catch(e){}}
function loadUsers(){try{const d=localStorage.getItem('users');if(d){state.users=JSON.parse(d)}}catch(e){}}
function saveCustomers(){try{localStorage.setItem('customers',JSON.stringify(state.customers))}catch(e){}}
function loadCustomers(){try{const d=localStorage.getItem('customers');if(d){state.customers=JSON.parse(d)}}catch(e){}}
async function fetchUsers(){try{const users=await apiGet('/api/users');state.users=Array.isArray(users)?users:[];saveUsers()}catch(e){state.users=[];saveUsers()}}
async function fetchCustomers(){try{const customers=await apiGet('/api/customers');state.customers=Array.isArray(customers)?customers:[];saveCustomers()}catch(e){state.customers=[];saveCustomers()}}
async function fetchChannels(){try{const channels=await apiGet('/api/channels');state.channels=Array.isArray(channels)?channels:[];saveChannels()}catch(e){state.channels=[];saveChannels()}}
